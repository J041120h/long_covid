================================================================================
CLUSTERING TEST FRAMEWORK FOR LONG COVID PSEUDOBULK DATA
================================================================================

Output directory: /dcs07/hongkai/data/harry/result/long_covid/clustering_evaluation/2

----------------------------------------
STEP 1: Loading Data
----------------------------------------
Loading h5ad from: /dcs07/hongkai/data/harry/result/long_covid/rna/pseudobulk/pseudobulk_sample.h5ad
  Shape: (35, 2000)
  obsm keys: ['X_DR_expression', 'X_DR_proportion', 'X_pca_expression_method', 'X_pca_proportion']

Loading metadata from: /dcl01/hongkai/data/data/hjiang/Data/long_covid/sample_meta.csv
  Samples in meta: 37
  Common samples: 35

----------------------------------------
STEP 2: Extracting Embeddings
----------------------------------------
Expression embedding shape: (35, 10)
Proportion embedding shape: (35, 5)

----------------------------------------
STEP 3: Preparing Metadata Categories
----------------------------------------

Categories to test:
  - month: k=3 (Time point (months: 1, 3, 6))
  - Sex: k=2 (Biological sex (Male/Female))
  - LC/Recovered: k=2 (Long COVID status)
  - BMI category: k=2 (BMI category (Normal/Elevated))
  - Age (binned): k=3 (Age tertiles)
  - OutSMART ID: k=16 (Patient identifier (16 patients))

----------------------------------------
STEP 4: Running Clustering Comparisons
----------------------------------------

======================================================================
EMBEDDING: EXPRESSION
======================================================================

  Category: month
    k=3, description: Time point (months: 1, 3, 6)
    Running K-means...
      NMI=0.051, Acc=0.371, p=0.6310 
    Running Hierarchical Consensus...
      NMI=0.059, Acc=0.457, p=0.8080 

  Category: Sex
    k=2, description: Biological sex (Male/Female)
    Running K-means...
      NMI=0.000, Acc=0.514, p=1.0000 
    Running Hierarchical Consensus...
      NMI=0.001, Acc=0.543, p=1.0000 

  Category: LC/Recovered
    k=2, description: Long COVID status
    Running K-means...
      NMI=0.002, Acc=0.543, p=1.0000 
    Running Hierarchical Consensus...
      NMI=0.003, Acc=0.571, p=1.0000 

  Category: BMI category
    k=2, description: BMI category (Normal/Elevated)
    Running K-means...
      NMI=0.001, Acc=0.514, p=1.0000 
    Running Hierarchical Consensus...
      NMI=0.000, Acc=0.514, p=1.0000 

  Category: Age (binned)
    k=3, description: Age tertiles
    Running K-means...
      NMI=0.112, Acc=0.457, p=0.1200 
    Running Hierarchical Consensus...
      NMI=0.188, Acc=0.429, p=0.0210 *

  Category: OutSMART ID
    k=16, description: Patient identifier (16 patients)
    Running K-means...
      NMI=0.634, Acc=0.343, p=0.1990 
    Running Hierarchical Consensus...
      NMI=0.629, Acc=0.314, p=1.0000 

======================================================================
EMBEDDING: PROPORTION
======================================================================

  Category: month
    k=3, description: Time point (months: 1, 3, 6)
    Running K-means...
      NMI=0.030, Acc=0.400, p=0.8210 
    Running Hierarchical Consensus...
      NMI=0.039, Acc=0.371, p=0.7340 

  Category: Sex
    k=2, description: Biological sex (Male/Female)
    Running K-means...
      NMI=0.044, Acc=0.629, p=0.1820 
    Running Hierarchical Consensus...
      NMI=0.145, Acc=0.686, p=0.0290 *

  Category: LC/Recovered
    k=2, description: Long COVID status
    Running K-means...
      NMI=0.022, Acc=0.600, p=0.5040 
    Running Hierarchical Consensus...
      NMI=0.017, Acc=0.600, p=0.6990 

  Category: BMI category
    k=2, description: BMI category (Normal/Elevated)
    Running K-means...
      NMI=0.005, Acc=0.543, p=0.7600 
    Running Hierarchical Consensus...
      NMI=0.035, Acc=0.571, p=0.4270 

  Category: Age (binned)
    k=3, description: Age tertiles
    Running K-means...
      NMI=0.125, Acc=0.514, p=0.1210 
    Running Hierarchical Consensus...
      NMI=0.192, Acc=0.571, p=0.0240 *

  Category: OutSMART ID
    k=16, description: Patient identifier (16 patients)
    Running K-means...
      NMI=0.837, Acc=0.629, p=0.0000 ***
    Running Hierarchical Consensus...
      NMI=0.811, Acc=0.600, p=0.0000 ***

  Saved: clustering_results.csv

----------------------------------------
STEP 5: Generating Visualizations
----------------------------------------
  Saved: nmi_heatmap_by_embedding.pdf
  Saved: category_comparison.pdf
  Saved: embedding_visualization.pdf
  Saved: confusion_matrices.pdf
  Saved: permutation_distributions.pdf
  Saved: detailed_metrics.pdf

----------------------------------------
STEP 6: Generating Summary Report
----------------------------------------

================================================================================
CLUSTERING AGREEMENT ANALYSIS SUMMARY REPORT
================================================================================

Analysis Date: 2025-12-11 23:48:07
Number of comparisons: 24

================================================================================
1. CATEGORY RANKING (by mean NMI across all methods/embeddings)
================================================================================

  1. OutSMART ID
     NMI:      0.7277 ± 0.1115 (max: 0.8368) ***
     Accuracy: 0.4714 ± 0.1658
     p-value:  0.0000

  2. Age (binned)
     NMI:      0.1540 ± 0.0418 (max: 0.1922) *
     Accuracy: 0.4929 ± 0.0634
     p-value:  0.0210

  3. Sex
     NMI:      0.0475 ± 0.0680 (max: 0.1446) *
     Accuracy: 0.5929 ± 0.0787
     p-value:  0.0290

  4. month
     NMI:      0.0447 ± 0.0130 (max: 0.0593) 
     Accuracy: 0.4000 ± 0.0404
     p-value:  0.6310

  5. LC/Recovered
     NMI:      0.0109 ± 0.0101 (max: 0.0217) 
     Accuracy: 0.5786 ± 0.0274
     p-value:  0.5040

  6. BMI category
     NMI:      0.0101 ± 0.0164 (max: 0.0345) 
     Accuracy: 0.5357 ± 0.0274
     p-value:  0.4270

================================================================================
2. EMBEDDING COMPARISON
================================================================================

  Expression:
     Mean NMI: 0.1399 ± 0.2368

  Proportion:
     Mean NMI: 0.1918 ± 0.3009

================================================================================
3. STATISTICAL SIGNIFICANCE SUMMARY
================================================================================

  Highly significant (p < 0.001): 2/24
  Significant (p < 0.01):         0/24
  Marginally significant (p < 0.05): 3/24
  Not significant (p >= 0.05):    19/24

  Highly significant results (p < 0.001):
    - OutSMART ID | proportion | K-means: NMI=0.8368
    - OutSMART ID | proportion | Hierarchical Consensus: NMI=0.8108

================================================================================
4. TOP 5 BEST PERFORMING COMBINATIONS
================================================================================

  1. OutSMART ID | proportion | K-means
     NMI=0.8368, Acc=0.6286, p=0.0000 ***

  2. OutSMART ID | proportion | Hierarchical Consensus
     NMI=0.8108, Acc=0.6000, p=0.0000 ***

  3. OutSMART ID | expression | K-means
     NMI=0.6343, Acc=0.3429, p=0.1990 

  4. OutSMART ID | expression | Hierarchical Consensus
     NMI=0.6290, Acc=0.3143, p=1.0000 

  5. Age (binned) | proportion | Hierarchical Consensus
     NMI=0.1922, Acc=0.5714, p=0.0240 *

================================================================================
5. INTERPRETATION
================================================================================

  Best matching category: OutSMART ID
  Mean NMI: 0.7277
  Significance: p = 0.0000

  STRONG AGREEMENT: The clustering strongly captures this metadata category.
  This suggests meaningful biological signal related to this variable.

  Saved: summary_report.txt

================================================================================
ANALYSIS COMPLETE
================================================================================

All outputs saved to: /dcs07/hongkai/data/harry/result/long_covid/clustering_evaluation/2

Files generated:
  - clustering_results.csv
  - summary_report.txt
  - nmi_heatmap_by_embedding.pdf
  - category_comparison.pdf
  - embedding_visualization.pdf
  - confusion_matrices.pdf
  - permutation_distributions.pdf
  - detailed_metrics.pdf
